<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Pull Golf - ver 1.3.0</title>
    <style>
        body { text-align: center; background: #1a1a1a; color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        canvas { background: #4568dc; background: linear-gradient(to bottom, #43cea2, #185a9d); touch-action: none; }
        .hud { position: absolute; top: 20px; left: 0; width: 100%; pointer-events: none; }
        .v-tag { position: absolute; bottom: 10px; left: 10px; font-size: 12px; color: rgba(255,255,255,0.5); }
        button { position: absolute; top: 20px; right: 20px; padding: 10px; cursor: pointer; border-radius: 5px; border: none; background: #eee; }
    </style>
</head>
<body>
    <div class="v-tag">ver 1.3.0 - Ultimate Pull Update</div>
    <div class="hud">
        <h2 id="msg">Stage 1</h2>
        <p>画面を大きく引っ張って！</p>
    </div>
    <button onclick="resetStage()">リトライ</button>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const gravity = 0.4;
        const groundY = canvas.height - 80;
        let currentStage = 0;
        let isDragging = false;
        let ball = { x: 100, y: groundY - 15, r: 15, vx: 0, vy: 0, moving: false };
        let pull = { x: 0, y: 0 };

        const stages = [
            { name: "基本のショット", hole: {x: canvas.width - 150, y: groundY}, walls: [] },
            { name: "高い壁を越えろ", hole: {x: canvas.width - 100, y: groundY}, walls: [{x: canvas.width/2, y: groundY-200, w: 40, h: 200}] },
            { name: "精密射撃", hole: {x: canvas.width - 100, y: groundY-250}, walls: [
                {x: canvas.width - 250, y: groundY-250, w: 250, h: 20}, // 足場
                {x: 400, y: groundY-150, w: 40, h: 150} // 邪魔な壁
            ] }
        ];

        // --- 操作イベント ---
        function handleStart(x, y) {
            if (ball.moving) return;
            isDragging = true;
            pull.x = x; pull.y = y;
        }

        function handleMove(x, y) {
            if (isDragging) {
                pull.x = x; pull.y = y;
            }
        }

        function handleEnd() {
            if (!isDragging) return;
            // ボールから指の地点への差分で飛ばす（逆方向に飛ばす）
            const dx = ball.x - pull.x;
            const dy = ball.y - pull.y;
            ball.vx = dx * 0.15;
            ball.vy = dy * 0.15;
            ball.moving = true;
            isDragging = false;
        }

        canvas.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
        window.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
        window.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('touchstart', e => { e.preventDefault(); handleStart(e.touches[0].clientX, e.touches[0].clientY); });
        canvas.addEventListener('touchmove', e => { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); });
        canvas.addEventListener('touchend', handleEnd);

        function update() {
            if (ball.moving) {
                ball.vy += gravity;
                ball.x += ball.vx;
                ball.y += ball.vy;

                // 地面
                if (ball.y + ball.r > groundY) {
                    ball.y = groundY - ball.r;
                    ball.vy *= -0.5;
                    ball.vx *= 0.98;
                }

                // 壁衝突
                stages[currentStage].walls.forEach(w => {
                    if (ball.x + ball.r > w.x && ball.x - ball.r < w.x + w.w &&
                        ball.y + ball.r > w.y && ball.y - ball.r < w.y + w.h) {
                        ball.vx *= -0.7;
                        ball.vy *= -0.7;
                    }
                });

                // 停止
                if (Math.abs(ball.vx) < 0.2 && Math.abs(ball.vy) < 0.2 && Math.abs(ball.y - (groundY - ball.r)) < 5) {
                    ball.moving = false;
                    ball.vx = 0; ball.vy = 0;
                }
            }

            // クリア判定
            const hole = stages[currentStage].hole;
            if (Math.hypot(ball.x - hole.x, ball.y - hole.y) < 25 && !ball.moving) {
                alert("Nice In!");
                currentStage = (currentStage + 1) % stages.length;
                resetStage();
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const stage = stages[currentStage];
            document.getElementById('msg').innerText = stage.name;

            // 地面
            ctx.fillStyle = "#27ae60";
            ctx.fillRect(0, groundY, canvas.width, 80);

            // 穴
            ctx.fillStyle = "black";
            ctx.beginPath();
            ctx.arc(stage.hole.x, stage.hole.y, 20, 0, Math.PI * 2);
            ctx.fill();

            // 壁
            ctx.fillStyle = "#7f8c8d";
            stage.walls.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));

            // 引っ張りガイド（矢印）
            if (isDragging) {
                const dx = ball.x - pull.x;
                const dy = ball.y - pull.y;
                ctx.beginPath();
                ctx.moveTo(ball.x, ball.y);
                ctx.lineTo(ball.x + dx, ball.y + dy);
                ctx.strokeStyle = "rgba(255, 255, 255, 0.8)";
                ctx.lineWidth = 5;
                ctx.stroke();
                
                // パワーメーター的な円
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, Math.hypot(dx, dy), 0, Math.PI*2);
                ctx.strokeStyle = "rgba(255, 255, 255, 0.2)";
                ctx.stroke();
            }

            // ボール
            ctx.fillStyle = "white";
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = "#333";
            ctx.stroke();

            update();
            requestAnimationFrame(draw);
        }

        function resetStage() {
            ball.x = 100;
            ball.y = groundY - 15;
            ball.vx = 0; ball.vy = 0; ball.moving = false;
        }

        draw();
    </script>
</body>
</html>
