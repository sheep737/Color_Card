<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>横視点ゴルフ - ステージ制</title>
    <style>
        body { text-align: center; background-color: #87CEEB; color: #333; font-family: sans-serif; margin: 0; overflow: hidden; }
        canvas { background-color: #a2d2ff; border-bottom: 50px solid #2ecc71; cursor: crosshair; touch-action: none; }
        .ui { position: absolute; top: 10px; width: 100%; pointer-events: none; }
        .stats { font-weight: bold; font-size: 20px; background: rgba(255,255,255,0.5); padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="ui">
        <h1>横視点ゴルフ</h1>
        <div class="stats">ステージ: <span id="stageNum">1</span></div>
        <p>ドラッグして放して飛ばそう！</p>
    </div>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const gravity = 0.5;
        const friction = 0.98;
        const bounce = -0.6;
        const groundY = canvas.height - 50;

        let currentStage = 0;
        let isDragging = false;
        let startPos = { x: 0, y: 0 };
        let currentPos = { x: 0, y: 0 };
        let ball = { x: 100, y: 0, radius: 15, vx: 0, vy: 0 };

        // ステージデータ (穴の位置と壁の配置)
        const stages = [
            { holeX: canvas.width - 150, walls: [] }, // ステージ1: 障害物なし
            { holeX: canvas.width - 100, walls: [{ x: canvas.width/2, y: groundY - 150, w: 30, h: 150 }] }, // ステージ2: 真ん中に壁
            { holeX: canvas.width - 80,  walls: [ // ステージ3: 高い壁と空中足場
                { x: 400, y: groundY - 250, w: 40, h: 250 },
                { x: 700, y: groundY - 100, w: 200, h: 20 }
            ]}
        ];

        function initStage() {
            const s = stages[currentStage];
            ball.x = 100;
            ball.y = groundY - ball.radius;
            ball.vx = 0;
            ball.vy = 0;
            document.getElementById('stageNum').innerText = currentStage + 1;
        }

        canvas.addEventListener('mousedown', (e) => { startPos = {x: e.clientX, y: e.clientY}; isDragging = true; });
        canvas.addEventListener('mousemove', (e) => { currentPos = {x: e.clientX, y: e.clientY}; });
        window.addEventListener('mouseup', () => {
            if (isDragging) {
                ball.vx = (startPos.x - currentPos.x) * 0.15;
                ball.vy = (startPos.y - currentPos.y) * 0.15;
                isDragging = false;
            }
        });

        function update() {
            if (!isDragging) {
                ball.vy += gravity;
                ball.x += ball.vx;
                ball.y += ball.vy;

                // 地面衝突
                if (ball.y + ball.radius > groundY) {
                    ball.y = groundY - ball.radius;
                    ball.vy *= bounce;
                    ball.vx *= friction;
                }

                // 壁との衝突判定
                stages[currentStage].walls.forEach(w => {
                    if (ball.x + ball.radius > w.x && ball.x - ball.radius < w.x + w.w &&
                        ball.y + ball.radius > w.y && ball.y - ball.radius < w.y + w.h) {
                        // 簡易的な跳ね返り（横から当たった場合を想定）
                        ball.vx *= -0.8;
                        ball.x += ball.vx; // 埋まり防止
                    }
                });

                // 画面端
                if (ball.x < 0 || ball.x > canvas.width) ball.vx *= -1;
            }

            // クリア判定
            const holeX = stages[currentStage].holeX;
            const dist = Math.hypot(ball.x - holeX, ball.y - groundY);
            if (dist < 30 && Math.abs(ball.vx) < 2) {
                alert("ステージクリア！");
                currentStage = (currentStage + 1) % stages.length;
                initStage();
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 穴の描画
            const holeX = stages[currentStage].holeX;
            ctx.fillStyle = "black";
            ctx.beginPath();
            ctx.arc(holeX, groundY, 25, Math.PI, 0);
            ctx.fill();

            // 壁の描画
            ctx.fillStyle = "#7f8c8d";
            stages[currentStage].walls.forEach(w => {
                ctx.fillRect(w.x, w.y, w.w, w.h);
            });

            // 引っ張りガイド
            if (isDragging) {
                ctx.beginPath();
                ctx.moveTo(ball.x, ball.y);
                ctx.lineTo(ball.x + (startPos.x - currentPos.x), ball.y + (startPos.y - currentPos.y));
                ctx.strokeStyle = "rgba(255,255,255,0.7)";
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // ボール
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = "white";
            ctx.fill();
            ctx.stroke();

            update();
            requestAnimationFrame(draw);
        }

        initStage();
        draw();
    </script>
</body>
</html>
