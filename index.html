<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Pull Golf - ver 1.1.0</title>
    <style>
        body { text-align: center; background-color: #87CEEB; color: #333; font-family: 'Helvetica', sans-serif; margin: 0; overflow: hidden; }
        canvas { background: linear-gradient(#a2d2ff, #e1f5fe); border-bottom: 50px solid #2ecc71; cursor: crosshair; touch-action: none; }
        .ui { position: absolute; top: 10px; width: 100%; pointer-events: none; text-shadow: 1px 1px 2px white; }
        .version-tag { position: absolute; top: 5px; left: 10px; font-size: 12px; color: #555; }
        .controls { position: absolute; bottom: 60px; right: 20px; pointer-events: auto; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #fff; border: 2px solid #333; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="version-tag">ver 1.1.0</div>
    <div class="ui">
        <h1>PULL GOLF</h1>
        <div id="stats" style="font-size: 20px;">Stage: <span id="stageNum">1</span> | Strokes: <span id="strokes">0</span></div>
    </div>
    
    <div class="controls">
        <button onclick="resetStage()">R: やり直し</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // ゲーム定数
        const gravity = 0.4;
        const friction = 0.98;
        const bounce = -0.6;
        const groundY = canvas.height - 50;

        // ゲーム状態
        let currentStage = 0;
        let strokes = 0;
        let isDragging = false;
        let startPos = { x: 0, y: 0 };
        let currentPos = { x: 0, y: 0 };
        let ball = { x: 100, y: 0, radius: 12, vx: 0, vy: 0, moving: false };

        // ステージデータ (wallsのtypeに'moving'を指定可能に)
        const stages = [
            { holeX: canvas.width - 150, walls: [] }, 
            { holeX: canvas.width - 100, walls: [{ x: canvas.width/2, y: groundY - 120, w: 20, h: 120, type: 'static' }] },
            { holeX: canvas.width - 80,  walls: [
                { x: 300, y: groundY - 200, w: 30, h: 200, type: 'static' },
                { x: 600, y: groundY - 100, w: 150, h: 20, type: 'moving', range: 100, speed: 0.05, baseTop: groundY - 100 }
            ]}
        ];

        function initStage() {
            const s = stages[currentStage];
            ball.x = 100;
            ball.y = groundY - ball.radius;
            ball.vx = 0;
            ball.vy = 0;
            ball.moving = false;
            document.getElementById('stageNum').innerText = currentStage + 1;
        }

        function resetStage() {
            strokes = 0;
            document.getElementById('strokes').innerText = strokes;
            initStage();
        }

        // イベント管理
        canvas.addEventListener('mousedown', (e) => {
            if (ball.moving) return;
            startPos = {x: e.clientX, y: e.clientY};
            currentPos = {x: e.clientX, y: e.clientY};
            isDragging = true;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) currentPos = {x: e.clientX, y: e.clientY};
        });

        window.addEventListener('mouseup', () => {
            if (isDragging) {
                ball.vx = (startPos.x - currentPos.x) * 0.12;
                ball.vy = (startPos.y - currentPos.y) * 0.12;
                ball.moving = true;
                isDragging = false;
                strokes++;
                document.getElementById('strokes').innerText = strokes;
            }
        });

        function update() {
            // 動く壁の更新
            stages[currentStage].walls.forEach(w => {
                if (w.type === 'moving') {
                    w.y = w.baseTop + Math.sin(Date.now() * w.speed * 0.05) * w.range;
                }
            });

            if (ball.moving) {
                ball.vy += gravity;
                ball.x += ball.vx;
                ball.y += ball.vy;

                // 地面
                if (ball.y + ball.radius > groundY) {
                    ball.y = groundY - ball.radius;
                    ball.vy *= bounce;
                    ball.vx *= friction;
                }

                // 衝突判定（壁）
                stages[currentStage].walls.forEach(w => {
                    if (ball.x + ball.radius > w.x && ball.x - ball.radius < w.x + w.w &&
                        ball.y + ball.radius > w.y && ball.y - ball.radius < w.y + w.h) {
                        ball.vx *= -0.8;
                        ball.x += (ball.vx > 0 ? 5 : -5); // 埋まり回避
                    }
                });

                // 停止判定
                if (Math.abs(ball.vx) < 0.2 && Math.abs(ball.vy) < 0.2 && ball.y >= groundY - ball.radius) {
                    ball.vx = 0; ball.vy = 0; ball.moving = false;
                }
            }

            // 穴
            const hX = stages[currentStage].holeX;
            if (Math.hypot(ball.x - hX, ball.y - groundY) < 25 && Math.abs(ball.vx) < 2) {
                alert(`Stage ${currentStage + 1} Clear!\nStrokes: ${strokes}`);
                currentStage = (currentStage + 1) % stages.length;
                strokes = 0;
                document.getElementById('strokes').innerText = strokes;
                initStage();
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 穴
            ctx.fillStyle = "#333";
            ctx.beginPath();
            ctx.arc(stages[currentStage].holeX, groundY, 20, Math.PI, 0);
            ctx.fill();

            // 壁
            ctx.fillStyle = "#5d4037";
            stages[currentStage].walls.forEach(w => {
                ctx.fillRect(w.x, w.y, w.w, w.h);
            });

            // 引っ張りライン
            if (isDragging) {
                ctx.beginPath();
                ctx.moveTo(ball.x, ball.y);
                ctx.lineTo(ball.x + (startPos.x - currentPos.x), ball.y + (startPos.y - currentPos.y));
                ctx.strokeStyle = "white";
                ctx.setLineDash([5, 5]);
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // ボール
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = "white";
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = "#333";
            ctx.stroke();

            update();
            requestAnimationFrame(draw);
        }

        initStage();
        draw();
    </script>
</body>
</html>
